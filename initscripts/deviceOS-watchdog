#!/bin/bash
# /etc/init.d/deviceOS-watchdog: starts deviceOS watchdog which Runner keeps fed.
# good article on runlevel info: http://www.thegeekstuff.com/2012/03/lsbinit-script/
# 
### BEGIN INIT INFO
# Provides:             deviceOSwatchdog
# Required-Start:       $remote_fs $time wwrelay
# Required-Stop:        
# Should-Start:         $network
# Should-Stop:          
# Default-Start:        5
# Default-Stop:         0 1 
# Short-Description:    watchdog timer for the relay
### END INIT INFO
source /etc/init.d/functions
WIGWAGROOT="/wigwag"
WIGWAGLOGROOT="/wigwag/log"
PIDROOT="/var/run"
SSLROOT="/mnt/.boot/.ssl"
maestroOK=$PIDROOT"/maestroOK"
PROG_PATH="/wigwag/system/bin"
PROG="deviceOSWD"
KEEPALIVE="/var/deviceOSkeepalive"
#this is fixed by the binary... you cannot change it, so go with it.
FIXED_PID_FILE="deviceOSWD.pid"
START_DEVICEOSWD_CMD="$PROG_PATH/$PROG -w 300 -m 90 -s $KEEPALIVE -d -p $PIDROOT/"
STOP_DEVICEOSWD_CMD="echo -e \"stop\" | socat unix-sendto:$KEEPALIVE STDIO"
THISLOG=$WIGWAGLOGROOT/"deviceOSWD.log"
RUNNER_LOG="${WIGWAGROOT}/log/runner.log"
WWRELAY_LOG=${WIGWAGLOGROOT}"/wwrelay.log"

# LED control is integrated with deviceOSWD, tried detecting the hardware inside devcieOSWD, that dint work 
# Detect the platform and swap the files 
PROG_RELAY="deviceOSWD_a10_relay"
PROG_RP200="deviceOSWD_a10_tiny841"

eeprog /dev/i2c-1 0x55 -f -r 0:10 2> /dev/null
if [[ $? -eq 0 ]]; then
    # hardwareversion="relay"
    START_DEVICEOSWD_CMD="$PROG_PATH/$PROG_RELAY -w 300 -m 90 -s $KEEPALIVE -d -p $PIDROOT/"
else
    START_DEVICEOSWD_CMD="$PROG_PATH/$PROG_RP200 -w 300 -m 90 -s $KEEPALIVE -d -p $PIDROOT/"
    # hardwareversion="RP200"
fi
_log() {
    echo -e "$(date -u): $1" >> $THISLOG
    echo -e "$1"
}

_throw_warning(){
    warning
    _log " $PROG $1" 1>&2
}

_throw_success(){
    success
    _log " $PROG $1" 1>&2
}

_throw_failure(){
    failure
    _log " $PROG $1" 1>&2
}

_throw_passed(){
    passed
    _log " $PROG $1" 1>&2
}

start() {
    _log "deviceOSWD start called"
    if [[ -e $maestroOK || 0 -eq 0 ]]; then
        _log "maestroOK"
    if [ -e "$PIDROOT/$PROG.pid" ]; then
        _log "Program is running, exit with error."
        pid=$(pgrep $PROG)
        _throw_warning "currently running ($pid)"
        exit 1
    else
        ## Change from /dev/null to something like /var/log/$PROG if you want to save output.
        pgrep $PROG
        pkill $PROG
        $START_DEVICEOSWD_CMD
        pid=$(pgrep $PROG)
        _throw_success "started ($pid)"
    fi
    else
        #When the relay doesn't have its keys in the right places, we dont autostart devicejs or the watchdog...
        _throw_failure "maestro flag is not OK"
        echo "did not start $0 deviceOS-watchdog because wwrelay said not to" >> $RUNNER_LOG
        echo "did not start $0 deviceOS-watchdog because wwrelay said not to" >> $WWRELAY_LOG
        #you must stop the middle boot deviceOSWD, otherwise you will bootloop in 300 seconds
        #this seems strange here, but the only way to stop the internal hardware timer is to take over the heartbeat, then stop the heartbeat
        pkill $PROG
         $START_DEVICEOSWD_CMD
        eval "$STOP_DEVICEOSWD_CMD"
        pkill $PROG
        rm "$PIDROOT/$FIXED_PID_FILE"
        exit 7
    fi
}
humanhalt() {
    if [ -e "$PIDROOT/$FIXED_PID_FILE" ]; then
        ## Program is running, so stop it
        pid=`cat $PIDROOT/$FIXED_PID_FILE`
        eval "$STOP_DEVICEOSWD_CMD"
        kill -9 $pid
        rm "$PIDROOT/$FIXED_PID_FILE"
        _throw_success "stopped ($pid)"
    else
        ## Program is not running, exit with error.
        _throw_warning "not started!" 1>&2
        exit 1
    fi
}


update(){
    t="$2"
    SOCATCMD="echo -e \"up $t\" | socat unix-sendto:$KEEPALIVE STDIO"; 
    echo "$SOCATCMD"
    eval "$SOCATCMD"
    if [[ $? -eq 0 ]]; then
        _throw_success "update successful"
    else
        _throw_failure "update failed"
    fi
}
panic(){
    insmod /lib/modules/4.2.0-rc8/extra/panic.ko
}

status(){
    if [[ -e $PIDROOT/$FIXED_PID_FILE ]]; then
        pid=$(pgrep $PROG)
        _throw_success "(pid $pid) is running... logging to /var/log/syslog"
    else
        _throw_warning "not running."
    fi
}

## Check to see if we are running as root first.
if [ "$(id -u)" != "0" ]; then
    echo "This script must be run as root" 1>&2
    exit 1
fi


case "$1" in
    start)
        #
        start
        exit 0
        ;;
    #
    humanhalt)
        #
        humanhalt
        exit 0
        ;;
    #
    status)
        #
        status
        exit 0
        ;;
    #
    panic)
        #
        panic
        exit 0
        ;;
    #
    reload|restart|force-reload)
        #
        humanhalt
        start
        exit 0
        ;;
    #
    update)
        #
        update $@
        exit 0
        ;;
    #
    **)
        #
        echo "Usage: $0 {start|humanhalt|status|panic|reload|restart|update <sec>}" 1>&2
        exit 1
        ;;
#
esac
